# Transaction Tracker

## Step 1: Henesis CLIをインストールする

### Henesis CLIのインストール

```bash
npm install -g @haechi-labs/henesis-cli
```

### Henesisアカウントでログイン

```bash
henesis login
```

## Step 2：サンプルコードを取得

Sample Repositoryを使用してTransaction Trackerがどのようにブロックチェーンのトランザクションの状態の変化を購読することができるかどうかについて説明します。

### Sample Repositoryインポート

```
git clone https://github.com/HAECHI-LABS/sample-tx-tracker
```

### Sampleディレクトリに移動

```
cd sample-tx-tracker
```

### Dependencyインストール

```
npm install
```

## Step 3：トランザクションの状態の変化を購読設定する

### ClientId、Private Keyとノードを設定する

Henesisを通じてトランザクションの状態の変化を購読するには、次のような情報が必要です。

* `CLIENT_ID` : `henesis account：describeで`確認することができます。
* `PRIVATE_KEY` : テストのために使用財布のプライベートキーです。**十分な量のイーサネットリウムがあるEOAアドレスのプライベートキーを入力します。** （[プライベートキーを確認する方法](https://metamask.zendesk.com/hc/en-us/articles/360015289632-How-to-Export-an-Account-Private-Key)）
* `NODE_ENDPOINT` : 接続ブロックチェーンのノードendpointです。 （[INFURAキーを確認する方法](https://infura.io/docs/gettingStarted/authentication)）

ClientIdは以下のようなCLIコマンドを使用して確認することができます。

```text
henesis account:describe
```

```text
Email: haechi@haechi.io
Name: haechi
Organization: haechi-labs
ClientId: a481485a958f1b82ac210ec4eea27943
```

設定ファイルである`.env`にClientIdとPrivate KeyとNode Endpointを記入します。

```javascript
CLIENT_ID=<your-client-id>
PRIVATE_KEY=<your private key>
NODE_ENDPOINT='https://ropsten.infura.io/v3/<your-key>'
```

### TransactionTracker生成する

`CLIENT_ID`を利用して、トランザクションの状態の変化を購読するためのTransactionTrackerインスタンスを生成することができます。

```javascript
const { TransactionTracker } = require('@haechi-labs/henesis-sdk-js');
const { CLIENT_ID, PRIVATE_KEY, NODE_ENDPOINT } = process.env;

const tracker = new TransactionTracker(CLIENT_ID, {
  platform: 'ethereum',
  network: 'ropsten',
});
```

{% hint style="info" %}
サポートしているブロックのチェーン一覧はこちらをご覧ください。
{% endhint %}

### トランザクションの状態の変化を購読する

`subscription`を利用して追跡したトランザクションの状態を購読することができます。

* `message.data.type`で追跡したトランザクションの状態を知ることができます。
* `message.ack（）`を最後に必ず呼び出さなければします。

```javascript
const subscription = await tracker.subscribe(
  "transaction",
    {
      subscriptionId: "your-subscription-id",
      ackTimeout: 30 * 1000 // default is 10 * 1000 (ms)
    }
);

subscription.on("message", async (message) => {
  console.log(`now transaction status is: ${message.data.type}`)
  switch(message.data.type) {
    case 'pending' :
      transactions[message.data.result.transactionHash] = { status: 'pending'}
      break;
    case 'receipt' :
      console.log('message.data.result',message.data.result)
      transactions[message.data.result.transactionHash] = { ...message.data.result, status: 'receipt' }
      break;
    case 'confirmation' :
      console.log('message.data.result',message.data.result)
      transactions[message.data.result.transactionHash] = {...message.data.result, status: 'confirmation' }
      break;
  }
  message.ack();
});

subscription.on("error", async (error) => {
  console.log('err',error);
});
```

### トランザクションの状態の変化を追跡する

`trackTransaction`関数を利用して、トランザクションを追跡します。

* 状態の変化を追跡したいトランザクションの`txHash`を設定します。
* `txHash`を`trackTransaction`に入れ追跡を開始します。
* `timeout` 30秒、そして`confirmation`は6に設定します。

```javascript
// Start tracking transaction
// txHash which is generated by web3 or could be copied by etherscan
tracker.trackTransaction(txHash, {
  timeout: 30*1000,
  confirmation: 6
});
```

## Step 4: トランザクションの状態の変化を確認する

APIサーバーを実行して、トランザクションの状態の変化を確認します。

```bash
$ node index
```

トランザクションの状態が変化してメッセージが配信されると、次のような情報を確認することができます。

```javascript
now transaction status is: receipt
message.data.result { blockHash:
   '0x1328a899d25d873b12836f6faa6e28df45aeafcd2cf2c4984e2a157cfeb3b69a',
  blockNumber: 6706349,
  contractAddress: null,
  cumulativeGasUsed: 21004,
  from: '0x453011a4f948b22762290c1f4de3e2210c311c06',
  gasUsed: 21004,
  logs: [],
  logsBloom:
   '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
  status: true,
  to: '0x453011a4f948b22762290c1f4de3e2210c311c06',
  transactionHash:
   '0xac1ad6d9f04161c2a4bbc0327a7a3a6a9bced4c5da9ff8752a3774fd98c51e7b',
  transactionIndex: 0 }
```

