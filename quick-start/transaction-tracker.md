# Transaction Tracker

## Step 1: Henesis CLI 설치하기

### Henesis CLI 설치‌

```bash
npm install -g @haechi-labs/henesis-cli
```

### Henesis 계정으로 로그인

```bash
henesis login
```

## Step 2: 샘플 코드 가져오기

Sample Repository를 통해 어떻게 블록체인 트랜잭션의 상태 변화를 구독할 수 있는지 설명합니다.

### Sample Repository 가져오기

```
git clone https://github.com/HAECHI-LABS/sample-tx-tracker
```

### Sample 디렉토리로 이동

```
cd sample-tx-tracker
```

### Dependency 설치

```
npm install
```

## Step 3: 트랜잭션 상태 변화 구독 설정하기

### ClientId, Private Key 및 노드 설정하기

Henesis를 통해 트랜잭션의 상태 변화를 구독하기 위해서는 다음과 같은 정보들이 필요합니다.

* `CLIENT_ID` : `henesis account:describe` 를 통해 확인할 수 있습니다. 
* `PRIVATE_KEY` :  테스트를 위해 사용할 지갑의 프라이빗 키입니다. **충분한 양의 이더리움이 있는 EOA 주소의 프라이빗 키를 입력합니다.** \([프라이빗 키 확인하는 방법](https://metamask.zendesk.com/hc/en-us/articles/360015289632-How-to-Export-an-Account-Private-Key)\)
* `NODE_ENDPOINT` : 연결할 블록체인 노드 endpoint 입니다. \([INFURA 키 확인하는 방법](https://infura.io/docs/gettingStarted/authentication)\)

ClientId는 아래와 같은 CLI 명령어를 통해 확인할 수 있습니다.

```text
henesis account:describe
```

```text
Email: haechi@haechi.io
Name: haechi
Organization: haechi-labs
ClientId: a481485a958f1b82ac210ec4eea27943
```

설정파일인 `.env` 에 ClientId 및 Private Key와 Node Endpoint를 기입해줍니다.

```javascript
CLIENT_ID=<your-client-id>
PRIVATE_KEY=<your private key>
NODE_ENDPOINT='https://ropsten.infura.io/v3/<your-key>'
```

### TransactionTracker 생성하기

`CLIENT_ID` 를 이용하여 트랜잭션 상태 변화 구독을 위한 TransactionTracker 인스턴스를 생성할 수 있습니다.

```javascript
const { TransactionTracker } = require('@haechi-labs/henesis-sdk-js');
const { CLIENT_ID, PRIVATE_KEY, NODE_ENDPOINT } = process.env;

const tracker = new TransactionTracker(CLIENT_ID, {
  platform: 'ethereum',
  network: 'ropsten',
});
```

{% hint style="info" %}
지원하는 블록체인 목록은 [여기](https://docs.henesis.io/v/ko/faq/supported-blockchains)를 참조하세요.
{% endhint %}

### 트랜잭션 상태 변화 구독하기

`subscription` 을 이용해 추적한 트랜잭션의 상태를 구독할 수 있습니다.

* `message.data.type` 에서 추적한 트랜잭션의 상태를 알 수 있습니다.
* `message.ack()` 를 마지막에 반드시 호출하여야 합니다. 

```javascript
const subscription = await tracker.subscribe(
  "transaction",
    {
      subscriptionId: "your-subscription-id",
      ackTimeout: 30 * 1000 // default is 10 * 1000 (ms)
    }
);

subscription.on("message", async (message) => {
  console.log(`now transaction status is: ${message.data.type}`)
  switch(message.data.type) {
    case 'pending' :
      transactions[message.data.result.transactionHash] = { status: 'pending'}
      break;
    case 'receipt' :
      console.log('message.data.result',message.data.result)
      transactions[message.data.result.transactionHash] = { ...message.data.result, status: 'receipt' }
      break;
    case 'confirmation' :
      console.log('message.data.result',message.data.result)
      transactions[message.data.result.transactionHash] = {...message.data.result, status: 'confirmation' }
      break;
  }
  message.ack();
});

subscription.on("error", async (error) => {
  console.log('err',error);
});
```

### 트랜잭션 상태 변화 추적하기

`trackTransaction` 함수를 이용하여 트랜잭션을 추적합니다.

* 상태 변화를 추적하고 싶은 트랜잭션의 `txHash` 를 설정합니다.
* `txHash` 를 `trackTransaction` 에 넣어 추적을 시작합니다.
* `timeout` 30초, 그리고 `confirmation` 은 6로 설정합니다.

```javascript
// Start tracking transaction
// txHash which is generated by web3 or could be copied by etherscan
tracker.trackTransaction(txHash, {
  timeout: 30*1000,
  confirmation: 6
});
```

## Step 4: 트랜잭션 상태 변화 확인하기

API 서버를 실행하고 트랜잭션의 상태 변화를 확인합니다.

```bash
$ node index
```

트랜잭션의 상태가 변화하고 메세지가 전달되면 다음과 같은 정보들을 확인할 수 있습니다.

```javascript
now transaction status is: receipt
message.data.result { blockHash:
   '0x1328a899d25d873b12836f6faa6e28df45aeafcd2cf2c4984e2a157cfeb3b69a',
  blockNumber: 6706349,
  contractAddress: null,
  cumulativeGasUsed: 21004,
  from: '0x453011a4f948b22762290c1f4de3e2210c311c06',
  gasUsed: 21004,
  logs: [],
  logsBloom:
   '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000',
  status: true,
  to: '0x453011a4f948b22762290c1f4de3e2210c311c06',
  transactionHash:
   '0xac1ad6d9f04161c2a4bbc0327a7a3a6a9bced4c5da9ff8752a3774fd98c51e7b',
  transactionIndex: 0 }
```

